# Tax Pro — System Documentation

## What Is Tax Pro?

Tax Pro is a Claude Code extension that provides strategic tax planning advice. It's built on four components:

1. **Profile** (`~/.claude/tax-profile.yaml`) — Your tax situation
2. **Commands** (`/tax-intake`, `/tax-documents`, `/tax-packet`) — Interactive workflows
3. **Agent** (`tax-strategist`) — Strategic advisor persona
4. **Knowledge Base** — Tax rules, limits, strategies, and state-specific rules

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            USER INTERACTION                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  /tax-intake      │  /tax-documents   │  /tax-packet    │  tax-strategist   │
│  Build profile    │  Process docs     │  Generate CPA   │  Get advice       │
│                   │  (OCR extract)    │  prep packet    │                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ~/.claude/tax-profile.yaml                           │
│  Phase 1: Flags (income types, deductions, situations)                      │
│  Phase 2: Documents (personalized checklist with sourcing info)             │
│  Phase 3: Amounts (income, contributions, withholding)                      │
│  Phase 4: Analysis (opportunities, CPA questions)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            KNOWLEDGE BASE                                    │
├───────────────────┬───────────────────┬───────────────────┬─────────────────┤
│  federal/         │  strategies/      │  state/           │  Advanced       │
│  - limits-2025    │  - hsa-maximize   │  - VA/ (complete) │                 │
│  - brackets-2025  │  - 401k-maximize  │  - _TEMPLATE/     │  probing-       │
│  - doc-mapping    │  - backdoor-roth  │                   │  questions.yaml │
│  - doc-sourcing   │  - roth-convert   │                   │                 │
│                   │  - charitable     │                   │  expert-        │
│                   │  - pal-planning   │                   │  rules.yaml     │
└───────────────────┴───────────────────┴───────────────────┴─────────────────┘
```

## Profile Phases

The profile progresses through 4 phases:

| Phase | What's Collected | How |
|-------|------------------|-----|
| 1 | Flags (what applies to you) | /tax-intake interview |
| 2 | Documents (personalized checklist) | Generated from flags |
| 3 | Amounts (income, contributions) | /tax-documents or manual |
| 4 | Analysis (opportunities, questions) | Generated by agent |

You can use the system at any phase — more data = more specific advice.

## Commands

### /tax-intake

Builds and updates your tax profile through a conversational interview.

**Flow:**
1. Personal info (filing status, state, dependents)
2. Income flags (W-2, 1099, rental, etc.)
3. Deduction flags (401k, HSA, charitable, etc.)
4. Special situations (multi-state, equity comp, rental)
5. Document checklist (with WHERE to get each document)
6. Amounts (optional, for calculations)

### /tax-documents

Processes actual tax documents (W-2s, 1099s, K-1s) using Claude's vision capabilities.

**Flow:**
1. User provides document (drag/drop, screenshot, or file path)
2. Claude extracts key fields (wages, withholding, contributions)
3. Shows extracted data for confirmation
4. Updates profile with amounts
5. Marks document as received

**Supported Documents:**
- W-2 (wages, withholding, 401k contributions)
- 1099-DIV (dividends)
- 1099-INT (interest)
- 1099-B (capital gains)
- 1099-R (retirement distributions)
- K-1 (partnership income)
- 1098 (mortgage interest)
- 1099-SA (HSA distributions)

### /tax-packet

Generates a markdown document for your CPA with:
- Profile summary
- Document status (with "where to get" for missing docs)
- Opportunities identified
- Questions to discuss
- Action items with deadlines

### tax-strategist agent

Load with: "Use the tax-strategist agent"

Provides:
- Strategic tax advice based on your profile
- Probing questions ("Have you considered...")
- Expert insights (compound patterns lazy preparers miss)
- Multi-year projections
- State-specific strategies
- Dollar savings calculations
- IRS/state code citations

## File Locations

| File | Location | Purpose |
|------|----------|---------|
| Profile | `~/.claude/tax-profile.yaml` | Your tax situation |
| Tax History | `~/.claude/tax-history.yaml` | Prior year data |
| Agent | `.claude/agents/tax-strategist.md` | Advisor persona |
| Commands | `.claude/commands/tax-*.md` | Interactive workflows |
| Rules | `.claude/rules/tax-security.md` | Security guidelines |
| Federal Rules | `knowledge-base/federal/` | Limits, brackets, doc mapping |
| Strategies | `knowledge-base/strategies/` | Tax optimization strategies |
| State Rules | `knowledge-base/state/[ST]/` | State-specific rules |
| Probing Qs | `knowledge-base/probing-questions.yaml` | Strategic questions |
| Expert Rules | `knowledge-base/expert-rules.yaml` | Compound patterns |

## Security Model

**Personal data stays local:**
```
PERSONAL (never commit)              SHAREABLE (commit freely)
─────────────────────────            ────────────────────────
~/.claude/tax-profile.yaml           knowledge-base/*
~/.claude/tax-history.yaml           .claude/agents/*
~/Documents/tax-packet-*.md          .claude/commands/*
```

- Profile stored in `~/.claude/` (not in repo)
- Never committed to git (in `.gitignore`)
- No SSNs or account numbers needed
- Documents processed but not stored

## Strategy Library

### Federal Strategies

| Strategy | Category | Applicable When |
|----------|----------|-----------------|
| HSA Maximize | Retirement | has_hsa: true |
| 401k Maximize | Retirement | has_401k: true |
| Backdoor Roth | Retirement | High income + has_roth |
| Roth Conversion | Retirement | Has Traditional IRA/401k |
| Charitable Bunching | Deduction | charitable_donations: true |
| PAL Planning | Real Estate | rental + suspended_pal |

### State Strategies (Virginia)

| Strategy | Category | Benefit |
|----------|----------|---------|
| VA 529 Deduction | Education | $4,000/account/year |
| VA vs DC Residence | Residency | Save $10K+ at high income |
| VA Estimated Timing | Compliance | Q1 due May 1, not April 15 |

### Probing Questions

Pattern-triggered strategic questions like:
- "You have Traditional IRA + want backdoor Roth. Have you considered the pro-rata rule?"
- "RSUs withheld at 22%, but you're in 32% bracket. Checked withholding?"
- "Near NIIT threshold. Managing investment income timing?"

### Expert Rules

Compound patterns that lazy preparers miss:
- Pro-rata rule trap (Traditional IRA + backdoor Roth)
- Cost segregation + PAL interaction
- QBI + Roth conversion coordination
- NIIT cliff effect management
- Gap year Roth conversion opportunity

## Adding New Content

### New Strategy

Create file in `knowledge-base/strategies/[category]/`:

```yaml
---
id: strategy_id
name: "Strategy Name"
category: category
priority: high/medium/low
applicable_when:
  - condition
savings_type: deduction/credit/deferral
deadline: "Date or ongoing"
irs_authority: "IRC § XXX"
---

# Strategy Name
...
```

### New State

1. Copy template: `cp -r knowledge-base/state/_TEMPLATE knowledge-base/state/[ST]`
2. Fill in `overview.yaml` (brackets, deadlines, conformity)
3. Fill in `strategies.yaml` (state-specific opportunities)

### New Probing Question

Add to `knowledge-base/probing-questions.yaml`:

```yaml
- id: question_id
  priority: high
  trigger:
    all:
      - condition: true
  question: "Have you considered...?"
  why: "Explanation"
  action: "What to do"
  source: "IRC § XXX"
```

## Limitations

Tax Pro is a **planning tool**, not:
- Tax filing software (use TurboTax, etc.)
- Legal advice (consult tax attorney)
- CPA replacement (complements, doesn't replace)
- Guaranteed savings (all estimates)

## Support

- Run `/tax-intake` to rebuild profile
- Run `/tax-documents` to process documents
- Delete `~/.claude/tax-profile.yaml` to start fresh
